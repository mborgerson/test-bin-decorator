on: push
jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - msvc_name: 'x86'
            build_name: 'x86'
          - msvc_name: 'x64'
            build_name: 'x86_64'
    name: build windows (${{ matrix.build_name }})
    steps:
      - name: clone
        uses: actions/checkout@v2
      - uses: TheMrMilchmann/setup-msvc-dev@v2
        with:
          arch: ${{ matrix.msvc_name }}
      - name: build
        run: python test.py build --tool msvc --arch ${{ matrix.build_name }}
      - name: put artifacts
        uses: actions/upload-artifact@v2
        with:
          name: binaries-${{ matrix.build_name }}
          path: binaries
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - name: deps
        run: sudo apt-get install -qq build-essential gcc-multilib clang
      - name: clone
        uses: actions/checkout@v2
      - name: build
        run: python test.py build --tool gcc clang
      - name: put artifacts
        uses: actions/upload-artifact@v2
        with:
          name: binaries-ubuntu
          path: binaries
  test:
    needs: [build-windows, build-ubuntu]
    runs-on: ubuntu-latest
    steps:
      - name: clone
        uses: actions/checkout@v2
      - name: get artifacts
        uses: actions/download-artifact@v2
      - name: list
        run: find .
      - name: merge artifacts
        run: mkdir -p binaries; mv binaries-*/* binaries; rmdir binaries-*
      - name: put artifacts
        uses: actions/upload-artifact@v2
        with:
          name: binaries-all
          path: binaries
      - name: list
        run: find .
      - name: test
        run: python test.py
